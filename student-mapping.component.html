<!-- FORM SECTION -->
<form
  style="background: #f9f9f9; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);"
>
  <div style="display: flex; align-items: center; flex-wrap: wrap; gap: 30px;">
    <!-- TERM & SCHOOL YEAR -->
    <div style="display: flex; align-items: center;">
      <label style="width: 160px; font-weight: 600; color: #0D47A1;"
        >Term & School Year:</label
      >
      <mat-form-field appearance="outline" style="width: 250px;">
        <mat-label>Select Term & School Year</mat-label>
        <mat-select
          [(ngModel)]="activeTerm"
          name="activeTerm"
          (selectionChange)="selectTermYear()"
        >
          <mat-option *ngFor="let item of combinedOptions" [value]="item.value">
            {{ item.label }}
          </mat-option>
        </mat-select>
      </mat-form-field>
    </div>

    <!-- DATE PICKER BUTTON -->
    <div style="display: flex; align-items: center;">
      <label style="width: 120px; font-weight: 600; color: #0D47A1;"
        >Exam Dates:</label
      >
      <!-- <button
        mat-raised-button
        color="primary"
        (click)="openExamDateDialog()"
        [disabled]="!activeTerm"
      >
        <mat-icon>calendar_today</mat-icon>
        Select Exam Dates
      </button> -->
    </div>

    <!-- SHOW SELECTED DATES -->
    <div
      *ngIf="selectedDates.length > 0"
      style="display: flex; align-items: center; gap: 10px;"
    >
      <mat-chip-list>
        <mat-chip
          *ngFor="let d of selectedDates"
          [removable]="true"
          (removed)="removeDate(d)"
        >
          {{ d | date: 'mediumDate' }}
          <mat-icon matChipRemove>cancel</mat-icon>
        </mat-chip>
      </mat-chip-list>
    </div>
  </div>

  <!-- NEXT BUTTON -->
  <div style="text-align: center; margin-top: 20px;">
    <button
      mat-raised-button
      color="accent"
      (click)="goNext()"
      [disabled]="!activeTerm || selectedDates.length === 0"
    >
      Next
    </button>
  </div>
  <!-- ✅ ADD THIS BUTTON in the form section, after the "Next" button -->
<div style="text-align: center; margin-top: 20px; display: flex; justify-content: center; gap: 10px;">
  <button
    mat-raised-button
    color="accent"
    (click)="goNext()"
    [disabled]="!activeTerm || selectedDates.length === 0"
  >
    Next
  </button>
  
  <!-- ✅ ADDED: Clear All Data Button -->
  <button
    mat-stroked-button
    color="warn"
    (click)="clearAllData()"
    matTooltip="Delete all exam schedules and reset"
  >
    <mat-icon>delete_forever</mat-icon> Clear All Data
  </button>
</div>
</form>

<!-- TABLE SECTION -->
<div
  class="p-4"
  *ngIf="showTable"
  style="background:#fff; border-radius:8px; box-shadow:0 3px 6px rgba(0,0,0,0.1);"
>
  <h2 style="color:#0D47A1; font-weight:600; margin-bottom: 15px;">
    Student Mapping
  </h2>

  <mat-tab-group>
    <mat-tab
      *ngFor="let day of selectedDates; let i = index"
      [label]="'Day ' + (i + 1)"
    >
      <div style="margin-top: 20px; overflow-x: auto;">
        <h3 style="color:#1565C0;">Schedule for {{ day | date: 'fullDate' }}</h3>

        <table
          border="1"
          cellspacing="0"
          cellpadding="8"
          style="width:100%; border-collapse: collapse; text-align: left;"
        >
          <thead style="background-color: #1565C0; color: white;">
            <tr>
              <th>Program (Year)</th>
              <th *ngFor="let slot of daysWithTimeSlots[day]">{{ slot }}</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let prog of programs">
              <td>
                <b>{{ prog.program }}</b> - Year {{ prog.year }}<br />
                <small
                  [style.color]="
                    getRemainingSubjectsConsideringAllDays(prog) === 0
                      ? 'green'
                      : 'red'
                  "
                >
                  Remaining:
                  {{ getRemainingSubjectsConsideringAllDays(prog) }}
                </small>
              </td>

              <td *ngFor="let slot of daysWithTimeSlots[day]">
               <select
                  [(ngModel)]="prog.schedule[day + '_' + slot]"
                  (focus)="capturePrev(prog, day + '_' + slot)"
                  (change)="onSubjectSelect(prog, slot, day)"
                  style="width: 160px; padding: 5px;"
                  [style.background-color]="prog.schedule[day + '_' + slot] ? '#e8f5e9' : 'white'"
                >
                  <option value=""></option>
                  <option
                    *ngFor="let subj of getAvailableSubjects(prog, day + '_' + slot)"
                    [value]="subj.subjectId"
                  >
                    {{ subj.subjectId }} - {{ subj.subjectTitle }}
                    <span *ngIf="subj.units">({{ subj.units }} units)</span>
                  </option>
                </select>
                 <div *ngIf="prog.schedule[day + '_' + slot]" style="font-size: 11px; color: #666; margin-top: 4px;">
                  <ng-container *ngFor="let subj of prog.subjects">
                    <span *ngIf="subj.subjectId === prog.schedule[day + '_' + slot]">
                      {{ subj.units }} units
                    </span>
                  </ng-container>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </mat-tab>
  </mat-tab-group>

  <div style="text-align:center; margin-top: 20px;">
    <button
      mat-raised-button
      color="primary"
      (click)="saveSchedule()"
      style="padding: 10px 25px;"
    >
      <mat-icon>save</mat-icon>
      Save Schedule
    </button>
  </div>
</div>